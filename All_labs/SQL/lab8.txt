-- 1. View for all flights departing on a specific date
CREATE VIEW flights_on_specific_date AS
SELECT *
FROM flights
WHERE scheduled_departure::date = '2024-11-14';

-- 2. View for bookings of flights scheduled within the next week
CREATE VIEW bookings_next_week AS
SELECT b.*
FROM booking_flight b
JOIN flights f ON b.flight_id = f.flight_id
WHERE f.scheduled_departure BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 days';

-- 3. View for top 5 most popular flight routes based on the number of bookings
CREATE VIEW top_5_routes AS
SELECT departure_airport_id, arrival_airport_id, COUNT(b.booking_id) AS booking_count
FROM flights f
JOIN booking_flight b ON f.flight_id = b.flight_id
GROUP BY f.departure_airport_id, f.arrival_airport_id
ORDER BY booking_count DESC
LIMIT 5;

-- 4. View for all flights of a specific airline
CREATE VIEW airline_flights AS
SELECT *
FROM flights
WHERE airline_id = 1;

-- 5. Modify the previous view to show only flights departing within the next 7 days
CREATE OR REPLACE VIEW airline_flights_next_week AS
SELECT *
FROM flights
WHERE airline_id = 1
AND scheduled_departure BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 days';

-- 6. View for flights delayed by more than 24 hours
CREATE VIEW delayed_flights AS
SELECT *
FROM flights
WHERE actual_departure > scheduled_departure + INTERVAL '24 hours';

-- 7. View for passenger details who booked on the 'Leffler-Thompson' platform
CREATE VIEW leffler_thompson_passengers AS
SELECT p.first_name || ' ' || p.last_name AS full_name, country_of_citizenship
FROM passengers p
JOIN booking b ON p.passenger_id = b.passenger_id
WHERE b.booking_platform = 'Leffler-Thompson';

-- 8. View for top 10 most visited countries
CREATE VIEW top_10_visited_countries AS
SELECT a.country, COUNT(b.booking_id) AS visit_count
FROM flights f
JOIN booking_flight b ON f.flight_id = b.flight_id
JOIN airport a ON f.arrival_airport_id=a.airport_id
GROUP BY a.country
ORDER BY visit_count DESC
LIMIT 10;

-- 9. Update an existing view by adding new information, e.g., adding 'status' column to 'delayed_flights'
CREATE VIEW l9_delayed_flights AS
SELECT f.*,
       CASE WHEN actual_departure > scheduled_departure + INTERVAL '24 hours' THEN 'Severely Delayed'
            ELSE 'Delayed' END AS s
FROM flights f
WHERE f.actual_departure > f.scheduled_departure + INTERVAL '24 hours';

SELECT * FROM l9_delayed_flights;

-- 10. Drop all created views
DROP VIEW IF EXISTS flights_on_specific_date, bookings_next_week, top_5_routes,
                   airline_flights, airline_flights_next_week, delayed_flights,
                   leffler_thompson_passengers, top_10_visited_countries;
